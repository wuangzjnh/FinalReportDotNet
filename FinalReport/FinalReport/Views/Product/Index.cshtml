@using FinalReport
@{
    ViewBag.Title = "Product";
}
<main class="main">
    <div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.jpg')">
        <div class="container">
            <h1 class="page-title">Danh sách<span>Shop</span></h1>
        </div><!-- End .container -->
    </div><!-- End .page-header -->
    <nav aria-label="breadcrumb" class="breadcrumb-nav mb-2">
        <div class="container">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Trang chủ</a></li>
                <li class="breadcrumb-item"><a href="#">Cửa hàng</a></li>
                <li class="breadcrumb-item active" aria-current="page">Danh sách</li>
            </ol>
        </div><!-- End .container -->
    </nav><!-- End .breadcrumb-nav -->

    <div class="page-content">
        <div class="container">
            <div class="row">
                <div class="col-lg-9">
                    <div class="toolbox">
                        <div class="toolbox-left">
                            <div class="toolbox-info">
                                Tổng cộng <span> 0 </span> sản phẩm
                            </div><!-- End .toolbox-info -->
                        </div><!-- End .toolbox-left -->

                        <div class="toolbox-right">
                            <div class="toolbox-sort">
                                <label for="sortby">Sắp xếp theo:</label>
                                <div class="select-custom">
                                    <select name="sortby" id="sortby" class="form-control">
                                        <option value="Date">Ngày đăng</option>
                                        <option value="Rated" selected="selected">Xếp hạng</option>
                                        <option value="PriceDown">Giá giảm dần</option>
                                        <option value="PriceUp">Giá tăng dần</option>


                                    </select>
                                </div>
                            </div><!-- End .toolbox-sort -->
                            <div class="toolbox-layout">
                                <a href="category-list.html" class="btn-layout active">
                                    <svg width="16" height="10">
                                        <rect x="0" y="0" width="4" height="4" />
                                        <rect x="6" y="0" width="10" height="4" />
                                        <rect x="0" y="6" width="4" height="4" />
                                        <rect x="6" y="6" width="10" height="4" />
                                    </svg>
                                </a>

                                <a href="category-2cols.html" class="btn-layout">
                                    <svg width="10" height="10">
                                        <rect x="0" y="0" width="4" height="4" />
                                        <rect x="6" y="0" width="4" height="4" />
                                        <rect x="0" y="6" width="4" height="4" />
                                        <rect x="6" y="6" width="4" height="4" />
                                    </svg>
                                </a>

                                <a href="category.html" class="btn-layout">
                                    <svg width="16" height="10">
                                        <rect x="0" y="0" width="4" height="4" />
                                        <rect x="6" y="0" width="4" height="4" />
                                        <rect x="12" y="0" width="4" height="4" />
                                        <rect x="0" y="6" width="4" height="4" />
                                        <rect x="6" y="6" width="4" height="4" />
                                        <rect x="12" y="6" width="4" height="4" />
                                    </svg>
                                </a>

                                <a href="category-4cols.html" class="btn-layout">
                                    <svg width="22" height="10">
                                        <rect x="0" y="0" width="4" height="4" />
                                        <rect x="6" y="0" width="4" height="4" />
                                        <rect x="12" y="0" width="4" height="4" />
                                        <rect x="18" y="0" width="4" height="4" />
                                        <rect x="0" y="6" width="4" height="4" />
                                        <rect x="6" y="6" width="4" height="4" />
                                        <rect x="12" y="6" width="4" height="4" />
                                        <rect x="18" y="6" width="4" height="4" />
                                    </svg>
                                </a>
                            </div><!-- End .toolbox-layout -->
                        </div><!-- End .toolbox-right -->
                    </div><!-- End .toolbox -->

                    <div class="products mb-3" id="products">
                    </div><!-- End .products -->

                    <nav aria-label="Page navigation">
                        <ul class="pagination">
                  
                        </ul>
                    </nav>
                </div><!-- End .col-lg-9 -->
                <aside class="col-lg-3 order-lg-first">
                    <div class="sidebar sidebar-shop">
                        <div class="widget widget-clean">
                            <label>Filters:</label>
                            <a href="#" class="sidebar-filter-clear">Clean All</a>
                        </div><!-- End .widget widget-clean -->

                        <div class="widget widget-collapsible">
                            <h3 class="widget-title">
                                <a data-toggle="collapse" href="#widget-1" role="button" aria-expanded="true" aria-controls="widget-1">
                                    Danh mục
                                </a>
                            </h3><!-- End .widget-title -->

                            <div class="collapse show" id="widget-1">
                                <div class="widget-body">
                                    <div class="filter-items filter-items-count">
                                        @{
                                            List<List<string>> categories = (List<List<string>>)ViewBag.Categories;
                                            if (categories != null)
                                            {

                                                foreach (var item in categories)
                                                {
                                                    <div class="filter-item">
                                                        <div class="custom-control custom-checkbox">
                                                            <input type="checkbox" name="category" class="custom-control-input" value="@item[0]" id="@item[0]">
                                                            <label class="custom-control-label" for="@item[0]">@item[1]</label>
                                                        </div><!-- End .custom-checkbox -->
                                                        <span class="item-count">@item[2]</span>
                                                    </div>

                                                    <!-- End .filter-item -->
                                                }
                                            }

                                        }

                                    </div><!-- End .filter-items -->
                                </div><!-- End .widget-body -->
                            </div><!-- End .collapse -->
                        </div><!-- End .widget -->

                        <div class="widget widget-collapsible">
                            <h3 class="widget-title">
                                <a data-toggle="collapse" href="#widget-2" role="button" aria-expanded="true" aria-controls="widget-2">
                                    Kích thước
                                </a>
                            </h3><!-- End .widget-title -->

                            <div class="collapse show" id="widget-2">
                                <div class="widget-body">
                                    <div class="filter-items">
                                        @{
                                            List<FinalReport.Models.Size> sizes = (List<FinalReport.Models.Size>)ViewBag.Sizes;
                                            foreach (var item in sizes)
                                            {
                                                <div class="filter-item">
                                                    <div class="custom-control custom-checkbox">
                                                        <input type="checkbox" name="size" value="@item.Id" class="custom-control-input" id="@item.Id">
                                                        <label class="custom-control-label" for="@item.Id">@item.Name</label>
                                                    </div><!-- End .custom-checkbox -->
                                                </div>

                                                <!-- End .filter-item -->
                                            }
                                        }


                                    </div><!-- End .filter-items -->
                                </div><!-- End .widget-body -->
                            </div><!-- End .collapse -->
                        </div><!-- End .widget -->

                        <div class="widget widget-collapsible">
                            <h3 class="widget-title">
                                <a data-toggle="collapse" href="#widget-3" role="button" aria-expanded="true" aria-controls="widget-3">
                                    Màu sắc
                                </a>
                            </h3><!-- End .widget-title -->

                            <div class="collapse show" id="widget-3">
                                <div class="widget-body">
                                    
                                            <div class="filter-colors">
                                            @{
                                                List<FinalReport.Models.Color> colors = (List<FinalReport.Models.Color>)ViewBag.Colors;
                                                    foreach (var item in colors)
                                                    {
                                                        <a href="#" data-id="@item.ID" style="background:@item.Code";><span class="sr-only">@item.Name</span></a>
                                                                       
                                                    }
                                            }
                                            </div>
                                        
                                    <!-- End .filter-colors -->
                                </div><!-- End .widget-body -->
                            </div><!-- End .collapse -->
                        </div><!-- End .widget -->

                        <div class="widget widget-collapsible">
                            <h3 class="widget-title">
                                <a data-toggle="collapse" href="#widget-4" role="button" aria-expanded="true" aria-controls="widget-4">
                                    Thương hiệu
                                </a>
                            </h3><!-- End .widget-title -->

                            <div class="collapse show" id="widget-4">
                                <div class="widget-body">
                                    <div class="filter-items">
                                        @{
                                            List<FinalReport.Models.Brand> brands = (List<FinalReport.Models.Brand>)ViewBag.Brands;
                                            foreach ( var item in brands)
                                            {
                                                <div class="filter-item">
                                                    <div class="custom-control custom-checkbox">
                                                        <input type="checkbox" name="brand" value="@item.Id" class="custom-control-input" id="@item.Id">
                                                        <label class="custom-control-label" for="@item.Id">@item.Name</label>
                                                    </div><!-- End .custom-checkbox -->
                                                </div>

                                                <!-- End .filter-item -->
                                            }
                                        }


                                    </div><!-- End .filter-items -->
                                </div><!-- End .widget-body -->
                            </div><!-- End .collapse -->
                        </div><!-- End .widget -->

              
                    </div><!-- End .sidebar sidebar-shop -->
                </aside><!-- End .col-lg-3 -->
            </div><!-- End .row -->
        </div><!-- End .container -->
    </div><!-- End .page-content -->
</main><!-- End .main -->

@section css{
    <link rel="stylesheet" href="/assets/css/plugins/nouislider/nouislider.css">
}
@section Js{
    <script src="/assets/js/nouislider.min.js"></script>
    <script src="path/to/jquery.js"></script>
    <script>
        $(function () {
            var CurrentPage = 1;
            LoadProducts();
            // $(document).on("click", ".megamenu-container > li > a", function (e) {
            //     e.preventDefault();
            //     $(".megamenu-container > li").removeClass("active");
            //     $(this).closest('li').addClass('active');
            //     LoadProducts();
            // });
            // Loc san pham theo Category
            $(document).on("change", "input[name=category], input[name=size], input[name=brand]", function (e) {
                e.preventDefault();
                LoadProducts();
            });
            // Loc san pham theo Color
            $(document).on("click", ".filter-colors a", function (e) {
                e.preventDefault();
                $(".filter-colors a").removeClass("selected");
                $(this).addClass("selected");
                LoadProducts();
            });
            // Sap xep san pham
            $("#sortby").change(function (e) {
                e.preventDefault();
                LoadProducts();
            });
            // Phan trang
            $(document).on("click", ".pagination li a", function (e) {
                e.preventDefault();
                CurrentPage = $(this).data("page");
                $(".pagination li").removeClass("active");
                LoadProducts();

            });

            // Lay gia tri phan tu duoc chon
            function LoadProducts() {
                let categories = $("input[name=category]:checked").map(function () {
                    return $(this).val();
                }).get();
                
                let sizes = $("input[name=size]:checked").map(function () {
                    return $(this).val();
                }).get();
                
                let colors = $(".filter-colors a.selected").data("id");

                let brands = $("input[name=brand]:checked").map(function () {
                    return $(this).val();
                }).get();
                let price = $("#filter-price-range").val();
                let sortby = $("#sortby").val();

                jQuery.ajaxSettings.traditional = true;
                $.get("/Product/Products",
                {
                    Categories:categories,
                    Sizes:sizes,
                    Color: colors,
                    Brands: brands,
                    PriceFrom:0,
                    PriceTo:1000,
                    SortBy: sortby,
                     PageNumber: CurrentPage
                }, function (items) {
                    console.log(items); 
                    $(".toolbox-info span").html(items["Totals"]);
                    var totalPages = parseInt(items["TotalPages"]);
                    
                    //Phan trang
                    $(".pagination").html("");
                     $(".pagination").append("<li class='page-item'>\
                        <a data-page='1' class='page-link page-link-prev' href='#' aria-label='Previous' tabindex='-1' aria-disabled='true'>\
                            <span aria-hidden='true'><i class='icon-long-arrow-left'></i></span>Trước\
                        </a>\
                        </li>"
                    );

                    let startPage = 1, endPage = totalPages;
                    if (CurrentPage - 2 > 1) {
                        startPage = CurrentPage - 2;
                    }
                        if (CurrentPage + 2 < totalPages) {
                        endPage = CurrentPage + 2;
                    }

                        for (let i = startPage; i <= endPage; i++) {
                        $(".pagination").append("<li class='page-item'><a data-page='"+ i +"'  class='page-link' href='#'>"+ i +"</a></li>");
                    }
                        
                        $(".pagination").append("<li class='page-item'>\
                            <a data-page='"+totalPages+"' class='page-link page-link-next' href='#' aria-label='Next'>\
                            Sau <span aria-hidden='true'><i class='icon-long-arrow-right'></i></span>\
                            </a>\
                            </li>"
                        );

                    $(".pagination li a[data-page=" + CurrentPage + "]").parent().addClass("active");
                    $(".pagination .page-link-prev, .page-link-next ").parent().removeClass("active");
                    $("#products").html("");

                    //Hien thi danh sach san pham
                    items["Products"].forEach(function (element) {
                        var picture = "";
                        var pic = element[5].split(',');
                        for (let i = 0; i < pic.length; i++) {
                                picture += '<a href="#" class="active">' +
                                    '<img src="/assets/images/'+pic[i]+'" alt="product desc">' +
                                    '</a>';
                        }
                        
                            var product = '<div class="product product-list">' +
                                '<div class="row">' +
                                '<div class="col-6 col-lg-3">' +
                                '<figure class="product-media">' +
                                '<span class="product-label label-new">New</span>' +
                                '<a href="/Product/Details/'+element[0]+'">' +
                                '<img src="/assets/images/'+element[1]+'" alt="Product image" class="product-image">' +
                                '</a>' +
                                '</figure>' +
                                '</div>' +

                                '<div class="col-6 col-lg-3 order-lg-last">' +
                                '<div class="product-list-action">' +
                                '<div class="product-price">' +'$'+
                                element[6] +
                                '</div>' +

                                '<div class="ratings-container">' +
                                '<div class="ratings">' +
                                '<div class="ratings-val" style="width: '+Math.floor(element[8]*20)+'%;"></div>' +
                                '</div>' +
                                '<span class="ratings-text">('+element[7]+' Reviews)</span>' +
                                '</div>' +

                                '<div class="product-action">' +
                                '<a href="popup/quickView.html" class="btn-product btn-quickview" title="Quick view"><span>Quick view</span></a>' +
                                '<a href="#" class="btn-product btn-compare" title="Compare"><span>compare</span></a>' +
                                '</div>' +

                                '<a href="#" class="btn-product btn-cart"><span>Thêm vào giỏ hàng</span></a>' +
                                '</div>' +
                                '</div>' +

                                '<div class="col-lg-6">' +
                                '<div class="product-body product-action-inner">' +
                                '<a href="#" class="btn-product btn-wishlist" title="Add to wishlist"><span>add to wishlist</span></a>' +

                                '<div class="product-cat">' +
                                '<a href="#">' + element[2] + '</a>' +
                                '</div>' +

                                '<h3 class="product-title"><a href="/Product/Details/'+element[0]+'">' + element[3] + '</a></h3>' +

                                '<div class="product-content">' +
                                '<p>'+element[4]+'</p>' +
                                '</div>' +

                                '<div class="product-nav product-nav-thumbs">' +
                                picture +
                                '</div>' +
                                '</div>' +
                                '</div>' +

                                '</div>' +
                                '</div>';
                            
                            $("#products").append(product);

                    });
                });
            }
        });
    </script>
}
